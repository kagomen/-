# メール

## メール送受信の流れ

- メール送信

  1. MUA（メールユーザエージェント）から、SMTP-AUTH（プロトコル） で メールサーバの MSA の 587 番サブミッションポートへメールデータを送信（SMTP 25 番ポートを使うことも可能）
  1. MSA から MTA の 25 番ポートにメールデータ を送信
  1. MTA から 別のメールサーバの MTA へ SMTP でメールデータを送信

  - 詳細

    1. 送信先メールアドレスの@以降のドメイン名を元に、DNS に送信先のメールサーバ名(MX レコード)を問い合わせる
    1. メールサーバ名の IP アドレス(A レコード)を DNS に問い合わせる
    1. IP アドレスにメールデータを送信する

- メール受信

  1. MTA は MDA にメールデータを受け渡す
  1. MDA はメールデータをメールボックスに格納する
  1. MUA は MRA に対し POP3 や IMAP で MRA にメール受信を要求する
  1. MRA は メールボックスからメールデータを取得し、MUA にメールデータを送信する

## メールのセキュリティ技術

- OP25B(Outbound Port 25 Blocking)

  - メールサーバへのアクセスに 25 番ポートを使用するとブロックされる（ネットワーク管理者が利用の制限をしているため）が、この機能は別プロバイダでも同じ。
  - 利用者が別プロバイダのメールサーバを利用したい際は、同プロバイダのメールサーバにアクセスするのと同じように、TCP587 番を利用して認証を行う
  - ただしメールサーバ同士の通信には 25 番が用いられている。メールサーバ同士の通信のセキュリティ対策は SMTP-AUTH ではなく次項の送信元ドメイン認証で行う。

- 送信元ドメイン認証

  - メールサーバ間で行われるセキュリティ対策

  - SPF(Sender Policy Framework)

    - IP アドレスを使用したセキュリティ対策
    - 流れ
      1. メールサーバは SPF レコード（メールサーバの IP アドレス情報）を DNS サーバに登録する
      1. メールを受信したメールサーバは、DNS サーバに受信したメールの送り元の SPF レコードを要求し、照合する
      - DNS から送られてきた SPF レコードが送り元の IP アドレスと一致する場合は認証成功（PASS）
      - DNS から送られてきた SPF レコードが送り元の IP アドレスと一致しない場合は認証失敗（Fail）
      - 送り元が SPF レコードを公開していない場合は認証情報なし（None）

  - DKIM(Domain Keys Identified Mail)

    - デジタル署名を使用したセキュリティ対策
    - 流れ
      1. 送信元のメールサーバに、秘密鍵と公開鍵を作成する
      1. 公開鍵の情報を TXT レコードで DNS に設定する
      1. メールを送信する
      - メールヘッダとメール本文から計算した値をもとに、メールサーバの秘密鍵で暗号化する
      - DKIM シグネチャヘッダというヘッダを使ってデジタル署名をつける
      1. 受信側は、メールサーバの秘密鍵によって暗号化されたデジタル署名を検証するために、DNS に対して公開鍵を要求する
      1. 公開鍵で暗号化されたデジタル署名を検証し、正規のメールサーバから送られてきたメールかどうかを確認する

  - DMARC(Domain-based Message Authentication, Reporting, and Conformance)
    - 送信側でメールのポリシーを公開し、SPF や DKIM による送信元ドメインを補助する仕組み
    - ポリシー（p）
      - 検証の失敗時にどのようにメールを扱うかを設定する
    - ポリシーの種類
      - none
        - 通常のメールとして扱う
      - quarantine
        - 隔離して迷惑メールフォルダに入れる
      - reject
        - メールを破棄する
    - 集約レポートの送り先（rua）
      - 検証失敗時のレポートの送信先を設定する
        - 自分のドメインになりすまされたメールがどれくらい発生しているのかを把握することができる

## メールに使用されるプロトコル

- SMTP(メール送信プロトコル)

  - 送信者(クライアント)がメールサーバへメールを送信する
  - 送信者のメールサーバから受信者のメールサーバへ転送する
  - ウェルノウンポート 25 番かサブミッションポートの 587 番が使用される

- POP3(メール受信プロトコル)

  - 受信者(クライアント)がメールサーバのメールボックスからメールデータをダウンロードする
  - ダウンロード時にメールサーバからメールが削除される（サーバではなく PC で管理する）
    - 複数の端末でメールデータを共有することが不可能
    - PC 側でバックアップをとる必要がある
  - ウェルノウンポート 110 番が使用される

- IMAP4(メール受信プロトコル)

  - POP3 と異なり、メールデータをメールサーバで管理する
  - 複数の端末でメールデータを共有できる
  - メールサーバに負荷がかかりやすい

- Web メール

  - HTTP 通信でメールの送受信を行う

## DNS レコード

- A レコード

  - メインの IP アドレスを保持するレコード

- AAAA レコード

  - ドメインに対する IPv6 アドレスを保有するレコード

- CNAME レコード

  - ドメインまたはサブドメインを別のドメインに転送する

- MX レコード

  - メールサーバにメールを送信する

- TXT レコード

  - ホスト名に関連づけるテキスト情報を定義する
  - SPF レコードはここに記載する

## 参考リンク

- https://www.cloudflare.com/ja-jp/learning/dns/dns-records/
- https://www.youtube.com/watch?v=a8o2vhVWK_k
- https://www.youtube.com/watch?v=RbygSd1f0dk
- https://www.youtube.com/watch?v=tcw2kT2DjL4
- https://www.youtube.com/watch?v=rMw4NcfPrN8
- https://www.youtube.com/watch?v=sBODqtd6Z0A

---
